---
import Layout from '../layouts/Layout.astro';
// Import dát vygenerovaných Python skriptom
// Uistite sa, že cesta sedí s OUTPUT_DATA_FILE v Pythone
import data from '../../../uradne_nastenky/4_diff_analysis.json';

// --- Pomocné funkcie ---
const formatDate = (dateString) => {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  // Jednoduché formátovanie, môžete použiť Intl.DateTimeFormat pre lepšiu lokalizáciu
  return date.toLocaleDateString('sk-SK');
};

// --- Príprava dát ---
// Sploštenie vnorenej štruktúry dát do jedného poľa dokumentov
const allDocuments = data.flatMap(krajData =>
  krajData.okresy.flatMap(okresData =>
    okresData.dokumenty_zivotne_prostredie.flatMap(kategoriaData =>
      kategoriaData.dokumenty.map(doc => ({
        ...doc, // Pôvodné vlastnosti dokumentu (datum, nazov, url, analyza)
        kraj: krajData.kraj, // Pridanie názvu kraja
        okres: okresData.nazov, // Pridanie názvu okresu
        has_analysis: !!doc.analyza // Pridanie príznaku pre jednoduchšiu kontrolu v šablóne
      }))
    )
  )
);
---

<Layout title="Nové dokumenty - Životné prostredie">
    {/* CSS pre Tabulator bude importované v skripte nižšie */}

    <main>
        <h1>Nové dokumenty na úradných tabuliach (ŽP)</h1>
        <button id="toggle-summaries-btn" style="width:14rem; margin-bottom: 15px; padding: 8px 12px; cursor: pointer;">Zobraziť všetky zhrnutia</button>
        <p>Zoznam dokumentov pridaných za posledný deň na úradné tabule okresných úradov životného prostredia.</p>
        {allDocuments.length === 0 ? (
            <p>Za posledný deň nepribudli žiadne nové dokumenty životného prostredia.</p>
        ) : (
            // Odstránili sme nadbytočný <table> tag
            <div id="documents-table"></div>
        )}
    </main>

    {/* 1. Vložíme dáta do skriptu typu application/json, aby ich externý JS mohol načítať */}
    <script type="application/json" id="table-data">
        {JSON.stringify(allDocuments)}
    </script>

    {/* 2. Importujeme externý skript, ktorý obsahuje logiku pre Tabulator */}
    {/* Astro/Vite spracuje tento import a jeho vnútorné importy (Tabulator, CSS) */}
    <script type="module" src="../scripts/initialize-table.js"></script>


    {/* Môžete pridať vlastné štýly pre Tabulator, ak potrebujete */}
    <style>

        /* Zabezpečí, aby body a html zabrali celú výšku a main sa mohol roztiahnuť */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Zabráni scrollbaru na body, ak sa všetko zmestí */
        }

        body {
            display: flex;
            flex-direction: column;
        }

        main {
            flex-grow: 1; /* Umožní main zabrať všetok dostupný priestor vo flex kontajneri (body) */
            overflow-y: hidden; /* Aby sa scrollbar objavil v tabuľke, nie v main */
            display: flex; /* Urobíme z main flex kontajner */
            flex-direction: column; /* Aby sa obsah v main usporiadal pod seba */
            padding: 1rem; /* Pridaj nejaký padding, ak je potrebný */
        }

        #documents-table {
            flex-grow: 1; /* Umožní tabuľke roztiahnuť sa v rámci main */
            min-height: 0; /* Dôležité pre flexbox, aby sa prvok mohol zmenšiť */
        }

        /* Príklad: Zväčšenie písma v hlavičke */
        /* .tabulator .tabulator-header .tabulator-col .tabulator-col-content {
            font-size: 1.1em;
        } */

        /* Zabezpečí, aby odkazy v bunkách vyzerali správne */
        .tabulator .tabulator-cell a {
            color: inherit; /* Alebo špecifická farba */
            text-decoration: underline;
        }
        .tabulator .tabulator-cell a:hover {
            color: blue;
        }
         /* Štýl pre textarea formatter - aby sa text pekne zobrazil */
        .tabulator-cell {
            white-space: pre-wrap; /* Umožní zalamovanie riadkov */
            word-wrap: break-word; /* Zalamovanie dlhých slov */
        }
        /* Štýl pre kontajner so zhrnutím */
        .row-summary {
            /* Štýly sú už definované inline v JS, ale tu môžeme pridať ďalšie */
            /* napr. špecifické písmo alebo farbu pozadia */
            font-size: 0.9em;
            /* Nové pravidlá pre kontajner: */
            max-width: 100%; /* Zabezpečí, že kontajner nepresiahne šírku rodiča (bunky) */
            overflow-x: auto; /* Ak je obsah stále príliš široký, pridá horizontálny scrollbar IBA pre tento kontajner */
            word-break: break-all; /* Agresívnejšie zalamovanie slov, ak by `pre-wrap` nestačilo */
        }
    </style>
</Layout>